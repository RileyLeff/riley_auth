# riley_auth configuration
#
# Config resolution order:
#   1. --config CLI flag
#   2. RILEY_AUTH_CONFIG env var
#   3. ./riley_auth.toml (walks up parent directories)
#   4. ~/.config/riley_auth/config.toml
#   5. /etc/riley_auth/config.toml
#
# Values support "env:VAR_NAME" syntax for secrets.

# NOTE: The default cookie_prefix changed from "riley_auth" to "auth" in v6.
# Existing deployments should set cookie_prefix = "riley_auth" to avoid
# logging out all users on upgrade, or plan a coordinated cookie migration.

[server]
host = "0.0.0.0"                          # Listen address (default: 0.0.0.0)
port = 8081                                # Listen port (default: 8081)
cors_origins = [                           # Allowed CORS origins
  "https://example.com",                   #   empty = no CORS (same-origin only)
  "https://app.example.com",               #   ["*"] = permissive (dev only)
]
# cookie_prefix = "auth"                    # Prefix for cookie names (default: "auth")
                                           #   Cookies: {prefix}_access, {prefix}_refresh, etc.
cookie_domain = ".example.com"             # Domain for auth cookies (enables subdomain SSO)
public_url = "https://example.com"         # Public base URL (used for OAuth callbacks and post-login redirects)
behind_proxy = false                       # Trust X-Forwarded-For headers for rate limiting (default: false)
                                           # IMPORTANT: When true, your reverse proxy MUST overwrite (not append to)
                                           # the X-Forwarded-For header with the real client IP. Otherwise, clients
                                           # can bypass rate limiting by sending a spoofed X-Forwarded-For header.
                                           # For nginx: proxy_set_header X-Forwarded-For $remote_addr;
                                           # For Cloudflare: this is handled automatically via CF-Connecting-IP.

[database]
url = "env:DATABASE_URL"                   # PostgreSQL connection string (supports env: syntax)
max_connections = 10                       # Connection pool size (default: 10)
# schema = "riley_auth"                    # Optional: SET search_path TO <schema> on each connection

[jwt]
access_token_ttl_secs = 900                  # Access token lifetime (default: 900 = 15 minutes)
refresh_token_ttl_secs = 2592000             # Refresh token lifetime (default: 2592000 = 30 days)
issuer = "my-auth"                           # JWT "iss" claim (REQUIRED — no default)
authorization_code_ttl_secs = 300            # OAuth authorization code lifetime (default: 300 = 5 min)
jwks_cache_max_age_secs = 3600               # Cache-Control max-age for /.well-known/jwks.json (default: 3600)

# Signing keys — the first key is the active signing key.
# Multiple keys enable zero-downtime key rotation: add a new key first,
# wait for caches to expire, then remove the old one.
# Supported algorithms: ES256 (recommended) and RS256.
# Generate with: riley-auth generate-keys --algorithm es256

[[jwt.keys]]
algorithm = "ES256"                          # ES256 (ECDSA P-256) or RS256 (RSA 2048+)
private_key_path = "/data/keys/private.pem"
public_key_path = "/data/keys/public.pem"
# kid = "key-2025"                           # Optional key ID (auto-generated from key hash if omitted)

# Legacy flat format is also supported (treated as a single RS256 key):
# private_key_path = "/data/keys/private.pem"
# public_key_path = "/data/keys/public.pem"

# OAuth providers — three tiers:
#   1. Built-in presets: name = "google" or "github" — just provide credentials
#   2. OIDC auto-discovery: specify issuer — endpoints discovered at startup
#   3. Manual OAuth2: specify auth_url, token_url, userinfo_url, profile_mapping
#
# Generate credentials at:
#   Google: https://console.cloud.google.com/apis/credentials
#   GitHub: https://github.com/settings/developers

# Account merge policy: controls automatic linking when a new OAuth login
# matches an existing account's email address.
#   "none"           — never auto-merge; prompt user to link accounts manually (default)
#   "verified_email" — auto-merge when the provider confirms the email is verified
#                      and exactly one existing user matches
# account_merge_policy = "none"

# URL of your login page. Used when prompt=login forces re-authentication.
# riley_auth redirects here with ?return_to=<authorize_url> so the user
# returns to the authorize flow after re-authenticating.
# If omitted, prompt=login returns ?error=login_required to the client.
# login_url = "https://auth.example.com/login"

# URL of your consent page. When a non-auto-approve client triggers the
# authorize flow, riley_auth redirects here with ?consent_id=<id>.
# consent_url = "https://auth.example.com/consent"

# Built-in preset: Google (just provide credentials)
[[oauth.providers]]
name = "google"
client_id = "env:GOOGLE_CLIENT_ID"
client_secret = "env:GOOGLE_CLIENT_SECRET"

# Built-in preset: GitHub (just provide credentials)
[[oauth.providers]]
name = "github"
client_id = "env:GITHUB_CLIENT_ID"
client_secret = "env:GITHUB_CLIENT_SECRET"

# OIDC auto-discovery example (uncomment to use):
# [[oauth.providers]]
# name = "corporate-sso"
# display_name = "Corporate SSO"
# client_id = "env:SSO_CLIENT_ID"
# client_secret = "env:SSO_CLIENT_SECRET"
# issuer = "https://sso.corp.example.com"
# scopes = "openid email profile"              # optional, defaults to "openid email profile"

# Manual OAuth2 example (uncomment to use):
# [[oauth.providers]]
# name = "custom-provider"
# display_name = "Custom Provider"
# client_id = "env:CUSTOM_CLIENT_ID"
# client_secret = "env:CUSTOM_CLIENT_SECRET"
# auth_url = "https://custom.example.com/authorize"
# token_url = "https://custom.example.com/token"
# userinfo_url = "https://custom.example.com/userinfo"
# scopes = "user:read"
# [oauth.providers.profile_mapping]
# provider_id = "uid"
# email = "email_address"
# name = "display_name"
# avatar_url = "photo"

# Optional: Define scopes that OAuth clients can request.
# Omit or leave empty for no scopes (backwards-compatible).

# [[scopes.definitions]]
# name = "read:profile"
# description = "Read your profile information"
#
# [[scopes.definitions]]
# name = "write:profile"
# description = "Update your profile information"

# Optional: Webhook delivery tuning.
# Omit for defaults (10 concurrent, 5 retry attempts, private IPs blocked).

# [webhooks]
# max_concurrent_deliveries = 10             # Max parallel outbound webhook requests (default: 10)
# max_retry_attempts = 5                     # Retries before marking delivery as failed (default: 5)
# allow_private_ips = false                  # Allow delivery to private/loopback IPs (default: false)
                                             # Set to true for development/testing with local webhook receivers

# Optional: Rate limiting tier configuration.
# Three tiers: auth (sensitive endpoints), standard (general API), public (discovery/health).
# Omit for defaults shown below.

# [rate_limiting]
# backend = "memory"                         # "memory" (default) or "redis"
# redis_url = "env:REDIS_URL"               # Required when backend = "redis"
#
# [rate_limiting.tiers.auth]
# requests = 15                              # Max requests per window (default: 15)
# window_secs = 60                           # Window size in seconds (default: 60)
#
# [rate_limiting.tiers.standard]
# requests = 60                              # Default: 60
# window_secs = 60                           # Default: 60
#
# [rate_limiting.tiers.public]
# requests = 300                             # Default: 300
# window_secs = 60                           # Default: 60

# Optional: Background maintenance / cleanup configuration.
# Omit for defaults shown below.

# [maintenance]
# cleanup_interval_secs = 3600                 # How often to run cleanup tasks (default: 3600 = 1 hour)
# webhook_delivery_retention_days = 7          # Days to keep webhook delivery records (default: 7)

# Optional: Prometheus metrics endpoint.
# When enabled, GET /metrics returns Prometheus text format.
# Omit or set enabled = false to disable (default).

# [metrics]
# enabled = true                               # Enable the /metrics endpoint (default: false)
# bearer_token = "env:METRICS_TOKEN"           # Optional: protect /metrics with a Bearer token

[usernames]
min_length = 3                             # Minimum username length (default: 3)
max_length = 24                            # Maximum username length (default: 24)
pattern = "^[a-zA-Z][a-zA-Z0-9_-]*$"      # Username regex (default: letter + alphanumeric/dash/underscore)
allow_changes = true                       # Allow username changes (default: true)
change_cooldown_days = 30                  # Days between username changes (default: 30)
old_name_hold_days = 90                    # Days old username is reserved after change (default: 90)
reserved = [                               # Blocked usernames (default: empty)
  "admin", "administrator", "system", "support", "help",
  "mod", "moderator", "root", "api", "auth", "blog",
  "null", "undefined", "deleted",
]
